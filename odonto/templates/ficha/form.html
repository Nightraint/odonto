{% extends "base.html" %}
{% block head %}
	<title>{{ funcion }} ficha</title>
{% endblock %}

{% block style %}
    <style>
        .img_wrp {
            display: inline-block;
            position: relative;
        }
        .close {
            position: absolute;
            top: 0;
            right: 0;
        }
        .add-photo {
            opacity: 0.5;
            filter: alpha(opacity=50); /* For IE8 and earlier */
        }
        .add-photo:hover {
            opacity: 1;
            filter: alpha(opacity=100); /* For IE8 and earlier */
        }
    </style>
{% endblock %}

{% block content %}
{% load staticfiles %}
    <div class="col-md-8 offset-md-2">
        {% if messages %}
            {% for message in messages %}
                <p>{{ message }}</p>
            {% endfor %}
        {% endif %}
        <form method= "POST" enctype="multipart/form-data">
            {% csrf_token %}
            {% for field in ficha_form %}
                {% if field.name == 'norma_trabajo' and ficha_form.initial.obra_social is None %}
                <p style="display:none;">
                {% else %}
                <p>
                {% endif %}
                    {{ field.errors }}
                    {{ field.label_tag }} {{ field }}
                    {% if field.help_text %}
                        <p class="help">{{ field.help_text|safe }}</p>
                    {% endif %}
                </p>
            {% endfor %}
            <div style="margin-bottom:1em">
                <label style="display:block;">Imagenes:</label>
                {{ imagenes_formset.management_form }}
                {% for imagen_form in imagenes_formset %}
                    <div class="imagenes-formset" style="height:100px;display:inline-block;">
                        <div style="display:none;">
                            {{ imagen_form.imagen }}
                            {{ imagen_form.id_img}}
                        </div>
                         <div style="display:block !important;" class="div-preview">
                            
                                <div ng-repeat="file in imagefinaldata" class="img_wrp" style="display:{% if imagen_form.initial.imagen %}block{% else %} none {% endif %};">
                            
                                    <img width=100 src="{{ imagen_form.initial.imagen.url }}" class="img-preview"/>
                                    <img class="close" src="/static/images/delete.png" onclick="eliminar(this);"/>
                                </div>
                        </div>
                        {% if not imagen_form.initial %}
                        <label for="{{imagen_form.imagen.auto_id}}" class="label-seleccionar" style="display:block !important;cursor:pointer;">
                            <div ng-repeat="file in imagefinaldata" class="img_wrp">
                                <img name="preview" class="img-preview add-photo" src="/static/images/add_photo.png" style="margin-right:10px;width:100px;"/>
                            </div>
                        </label>
                        {% endif %}
                        {% if imagen_form.imagen.errors %}
                            {% for error in imagen_form.imagen.errors %}
                                {{ error|escape }}
                            {% endfor %}
                        {% endif %}
                    </div>
                {% endfor %}
                {% if imagen_form.non_form_errors %}
                    {% for error in imagen_form.non_form_errors %}
                        {{ error|escape }}
                    {% endfor %}
                {% endif %}
            </div>
            <p style="text-align:center;">
                <input type="submit" name="ficha-submit" class="btn-lila" value="Aceptar" />
            </p>
        </form>
    </div>
{% endblock %}

{% block script %}
    <!-- Include formset plugin - including jQuery dependency -->
    <!--script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.formset/1.2.2/jquery.formset.js"></script>
    
    <script>
        var select_paciente = document.getElementById('id_paciente');
        var select_odontologo = document.getElementById('id_odontologo');
        var select_obra_social = document.getElementById('id_obra_social');
        var select_norma_trabajo = document.getElementById('id_norma_trabajo');
        var fecha = document.getElementById("id_fecha");

        function load_complete_ficha() {
            var paciente = parseInt(select_paciente.value);
            if (isNaN(paciente) == true){
                select_odontologo.parentNode.style.display = 'none';
                removeOptions(select_odontologo);
                select_obra_social.parentNode.style.display = 'none';
                removeOptions(select_obra_social);
                select_norma_trabajo.parentNode.style.display = 'none';
                removeOptions(select_norma_trabajo);
            }
            select_paciente.addEventListener("change", cargar_odontologos);
            select_paciente.addEventListener("change", cargar_obras_sociales);
            select_odontologo.addEventListener("change", cargar_obras_sociales);
            select_obra_social.addEventListener("change", cargar_normas_trabajo);
            select_norma_trabajo.addEventListener("change", chequear_norma);
            fecha.addEventListener("change", chequear_norma);
        }
        window.addEventListener("load", load_complete_ficha, false);

        var xhttp_o = new XMLHttpRequest();
        xhttp_o.onreadystatechange = createCallback(select_odontologo);

        var xhttp_os = new XMLHttpRequest();
        xhttp_os.onreadystatechange = respuestaObraSocial();

        var xhttp_nt = new XMLHttpRequest();
        xhttp_nt.onreadystatechange = createCallback(select_norma_trabajo);

        var xhttp_chequear_norma = new XMLHttpRequest();
        xhttp_chequear_norma.onreadystatechange = createCallbackChequearNorma();

        function respuestaObraSocial(){
            console.log('Cargando obras sociales');
            return function (){
                removeOptions(select_obra_social);
                if (this.readyState == 4 && this.status == 200) {
                    var opt = document.createElement('option');
                    opt.appendChild(document.createTextNode('Seleccionar'));
                    opt.value = '';
                    select_obra_social.appendChild(opt);
                    var arr = JSON.parse(this.responseText);
                    if(arr.length == 0)
                        select_norma_trabajo.parentNode.style.display = 'none';
                    for (i in arr) {
                        opt = document.createElement('option');
                        opt.appendChild(document.createTextNode(arr[i].descrip));
                        opt.value = arr[i].id; 
                        select_obra_social.appendChild(opt);
                    }
                    select_obra_social.parentNode.style.display = 'block';
                }
            }
        }

        function createCallbackChequearNorma() {
            console.log('callback creado para chequear norma');
            return function() {
                if (this.readyState == 4 && this.status == 200) {
                    var today = new Date();  
                    console.log(today + ": " + this.readyState + " - " + this.responseText);
                    var r = JSON.parse(this.responseText);
                    console.log(r);

                    var div_borrar = document.getElementById('mensaje_chequear_norma');
                    if (div_borrar)
                        div_borrar.parentNode.removeChild(div_borrar);
                    
                    div_mensaje = document.createElement('div');
                    div_mensaje.id = 'mensaje_chequear_norma';
                    div_mensaje.classList.add('alert');
                    div_mensaje.style = 'margin-top:5px;'
                    div_mensaje.innerHTML = '<a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>';
                    div_mensaje.innerHTML += '<strong id="resultado_chequear_norma"></strong>';
                    div_mensaje.innerHTML += '<label id="label_mensaje_chequear_norma"></label>';
                    var clase = '';
                    if (r.result == 'OK')
                        clase = 'alert-success';
                    else
                        clase = 'alert-danger';
                    div_mensaje.classList.add(clase);

                    select_norma_trabajo.parentElement.appendChild(div_mensaje);

                    var label_mensaje_chequear_norma = document.getElementById('label_mensaje_chequear_norma');
                    var resultado_chequear_norma = document.getElementById('resultado_chequear_norma');
                    label_mensaje_chequear_norma.innerHTML = r.message;
                    if(r.result != 'OK')
                    {
                        resultado_chequear_norma.innerHTML = r.result;
                        label_mensaje_chequear_norma.innerHTML += ' <a href="'+r.enlace+'" target="blank">VER FICHA</a>'
                    }
                }
            };
        }

        function chequear_norma(){
            var paciente = parseInt(select_paciente.value);
            var norma_trabajo = parseInt(select_norma_trabajo.value);
            console.log('chequear norma: paciente: ' + paciente + ". norma: " + norma_trabajo);
            if (isNaN(paciente) == false && isNaN(norma_trabajo) == false && fecha.value){
                xhttp_chequear_norma.open("GET", "/paciente/chequear_norma?paciente=" + paciente + "&norma_trabajo=" + norma_trabajo + "&fecha=" + fecha.value, true);
                xhttp_chequear_norma.send();
            }
        }
        
        function createCallback(select){
            console.log('callback creado para: ' + select.id);
            return function() {
                console.log(this.responseText);
                removeOptions(select);
                if (this.readyState == 4 && this.status == 200) {
                    var opt = document.createElement('option');
                    opt.appendChild(document.createTextNode('Seleccionar'));
                    opt.value = '';
                    select.appendChild(opt);
                    var arr = JSON.parse(this.responseText);
                    for (i in arr) {
                        opt = document.createElement('option');
                        opt.appendChild(document.createTextNode(arr[i].descrip));
                        opt.value = arr[i].id; 
                        select.appendChild(opt);
                    }
                    select.parentNode.style.display = 'block';
                }
            };
        }

        function cargar_odontologos(){
            console.log('cargar odontologos');
            var paciente = parseInt(select_paciente.value);
            if (isNaN(paciente) == false){
                xhttp_o.open("GET", "/odontologo/get_for_select?paciente=" + paciente, true);
                xhttp_o.send();
            }
            else{
                select_odontologo.parentNode.style.display = 'none';
                removeOptions(select_odontologo);
                select_obra_social.parentNode.style.display = 'none';
                removeOptions(select_obra_social);
                select_norma_trabajo.parentNode.style.display = 'none';
                removeOptions(select_norma_trabajo);
            }
        }

        function cargar_obras_sociales(){
            console.log('cargar obras sociales');
            var paciente = parseInt(select_paciente.value);
            var odontologo = parseInt(select_odontologo.value);
            if (isNaN(odontologo) == false && isNaN(paciente) == false){
                xhttp_os.open("GET", "/obra_social/get_for_select?odontologo=" + odontologo + "&paciente="+ paciente, true);
                xhttp_os.send();
            }
            else{
                select_obra_social.parentNode.style.display = 'none';
                removeOptions(select_obra_social);
                select_norma_trabajo.parentNode.style.display = 'none';
                removeOptions(select_norma_trabajo);
            }
        }

        function cargar_normas_trabajo(){
            var obra_social = parseInt(select_obra_social.value);
            console.log('cargar normas de trabajo de la obra social ' + obra_social);
            if (isNaN(obra_social) == false){
                xhttp_nt.open("GET", "/norma_trabajo/get_for_select?obra_social=" + obra_social, true);
                xhttp_nt.send();
            }
            else{
                select_norma_trabajo.parentNode.style.display = 'none';
                removeOptions(select_norma_trabajo);
            }
        }

        function removeOptions(selectbox){
            var i;
            for(i = selectbox.options.length - 1 ; i >= 0 ; i--)
            {
                selectbox.remove(i);
            }
        }

        function readURL(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    contenedor = input.parentNode.parentNode;
                    let div_preview = contenedor.querySelector(".div-preview");
                    let img_preview = div_preview.querySelector(".img-preview");
                    let img_wrp = div_preview.querySelector(".img_wrp");
                    img_wrp.style.display = "block";

                    let label = contenedor.querySelector(".label-seleccionar");
                    label.remove();

                    $(img_preview).attr("src", e.target.result);
                    agregar_imagen();
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        $(".cargar_imagen").change(function() {
            readURL(this);
        });

        $('.imagenes-formset').formset({
            addText: '',
            deleteText: '',
            prefix: "{{ imagenes_formset.prefix }}"
        });

        function eliminar(icon){
            let contenedor = icon.parentNode.parentNode.parentNode;
            let boton_eliminar = contenedor.querySelector(".delete-row");
            boton_eliminar.click();
        }

        function agregar_imagen(){
            let boton_agegar = document.querySelector(".add-row");
            boton_agegar.click();
        }
    </script>
{% endblock %}
