{% extends "base.html" %}
{% block head %}
	<title>{{ funcion }} ficha</title>
{% endblock %}

{% block style %}
    <style>
        .label_preview{
            text-align:center;
            width:150px;
            padding-top:20px;
            font-size: 12px;
            max-height:100px;
            cursor:pointer;
        }
        .label_preview:hover{
            color:blue;
        }
        .img_preview{
            cursor:pointer;
            padding-top:21px;
            width:150px;
        }
        .img_preview:hover{
            opacity: 0.5;
            filter: alpha(opacity=50); /* For IE8 and earlier */
        }
        .img_wrp {
            display: inline-block;
            position: relative;
        }
        .close {
            position: absolute;
            top: .25rem;
            right: .25rem;
        }
        .add-photo {
            opacity: 0.5;
            filter: alpha(opacity=50); /* For IE8 and earlier */
        }
        .add-photo:hover {
            opacity: 1;
            filter: alpha(opacity=100); /* For IE8 and earlier */
        }
        button.accordion {
            background-color: #eee;
            color: #444;
            cursor: pointer;
            padding: 18px;
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 15px;
            transition: 0.2s;
            font-weight:bold;
        }

        button.accordion.active, button.accordion:hover {
            background-color: #c1c0d8;
        }

        button.accordion:after {
            content: '\02795';
            font-size: 13px;
            color: #777;
            float: right;
            margin-left: 5px;
        }

        button.accordion.active:after {
            content: "\2796";
        }

        div.panel {
            background-color: #f0eff5;
            max-height: 0;
            overflow: hidden;
            transition: 0.2s ease-in-out;
            opacity: 0;
            padding:5px;
        }

        div.panel.show {
            opacity: 1;
            max-height:fit-content;
            transition: 0.2s;
            background-color: #c1c0d8;
        }
    </style>
{% endblock %}

{% block content %}
{% load staticfiles %}
    <div class="col-md-8 offset-md-2">
        {% if messages %}
            {% for message in messages %}
                <p>{{ message }}</p>
            {% endfor %}
        {% endif %}
        <form method= "POST" enctype="multipart/form-data">
            {% csrf_token %}
            {% for field in ficha_form %}
                {% if field.name == 'norma_trabajo' and ficha_form.initial.obra_social is None %}
                <p style="display:none;">
                {% else %}
                <p>
                {% endif %}
                    {{ field.errors }}
                    {{ field.label_tag }} {{ field }}
                    {% if field.help_text %}
                        <p class="help">{{ field.help_text|safe }}</p>
                    {% endif %}
                </p>
            {% endfor %}
            <div style="margin-bottom:1em">
                <button type="button" class="accordion">Im√°genes</button>
                <div class="panel">
                {{ imagenes_formset.management_form }}
                {% for imagen_form in imagenes_formset %}
                    <div class="imagenes-formset" style="margin-bottom:0.4em;">
                        <div style="display:none;">
                            {{ imagen_form.imagen }}
                            {{ imagen_form.id_img}}
                            {% if imagen_form.initial%}
                                <input class="url" value="{{ imagen_form.initial.imagen.url }}">
                                <input class="filename" value="{{ imagen_form.initial.filename }}">
                            {% else %}
                                <input class="filename" value="">
                            {% endif %}
                        </div>
                         <div style="display:none;background-color:#f0eff5;padding:10px 5px;position:relative;border:1px solid #413e66;border-radius:.25rem;" class="div_preview">
                            <img class="close" src="/static/images/delete.png" onclick="eliminar(this);"/>
                            <div ng-repeat="file in imagefinaldata" class="img_wrp">
                                <label style="display:none;" class="label_preview" onclick="ver_archivo(this);" title="Descargar archivo"></label>
                                <img onError="errorImagen(this);" style="display:none;" class="img_preview" onclick="ver_imagen(this);" title="Ver imagen"/>
                            </div>
                            {{ imagen_form.descripcion }}
                        </div>
                        {% if not imagen_form.initial %}
                        <label for="{{imagen_form.imagen.auto_id}}" class="label-seleccionar" style="display:block !important;cursor:pointer;">
                            <div ng-repeat="file in imagefinaldata" class="img_wrp">
                                <img name="preview" class="img-preview add-photo" src="/static/images/add_photo.png" style="margin-right:10px;width:100px;" title="Agregar imagen"/>
                            </div>
                        </label>
                        {% endif %}
                        {% if imagen_form.imagen.errors %}
                            {% for error in imagen_form.imagen.errors %}
                                {{ error|escape }}
                            {% endfor %}
                        {% endif %}
                    </div>
                {% endfor %}
                {% if imagen_form.non_form_errors %}
                    {% for error in imagen_form.non_form_errors %}
                        {{ error|escape }}
                    {% endfor %}
                {% endif %}
                </div>
            </div>
             <div style="margin-bottom:1em">
                <label style="display:block;">Consultas:</label>
                {{ consultas_formset.management_form }}
                {% for form in consultas_formset %}
                    <div class="consultas-formset" style="margin-bottom:0.4em;">
                     <div style="display:none;">
                        {{ form.id_consulta }}
                    </div>
                    {% if form.initial %}
                        <button type="button" class="accordion">Consulta del {{form.initial.fecha}}</button>
                        <div class="panel">
                    {% else %}
                        <div style="background-color:#f0eff5;padding:10px 5px;">
                    {% endif%}
                        <div class="row">
                            <div class="col-md-4">
                                {{ form.fecha }}
                                {% if form.fecha.errors %}
                                    {% for error in form.fecha.errors %}
                                        {{ error|escape }}
                                    {% endfor %}
                                {% endif %}
                            </div>
                            <div class="col-md-4">
                                {{ form.obra_social }}
                                {% if form.obra_social.errors %}
                                    {% for error in form.obra_social.errors %}
                                        {{ error|escape }}
                                    {% endfor %}
                                {% endif %}
                            </div>
                            <div class="col-md-4">
                                {{ form.norma_trabajo }}
                                {% if form.norma_trabajo.errors %}
                                    {% for error in form.norma_trabajo.errors %}
                                        {{ error|escape }}
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                {{ form.detalle }}
                                {% if form.detalle.errors %}
                                    {% for error in form.detalle.errors %}
                                        {{ error|escape }}
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% if consultas_formset.non_form_errors %}
                    {% for error in consultas_formset.non_form_errors %}
                        {{ error|escape }}
                    {% endfor %}
                {% endif %}
            </div>
            <p style="text-align:center;">
                <input type="submit" name="ficha-submit" class="btn-lila" value="Aceptar" />
            </p>
        </form>
    </div>
{% endblock %}

{% block script %}
    <!-- Include formset plugin - including jQuery dependency -->
    <!--script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script-->
    <script src="{% static 'js/jquery.formset.js' %}"></script>
    
    <script>
        var select_paciente = document.getElementById('id_paciente');
        var select_odontologo = document.getElementById('id_odontologo');
        var select_obra_social = document.getElementById('id_obra_social');
        var select_norma_trabajo = document.getElementById('id_norma_trabajo');
        var fecha = document.getElementById("id_fecha");

        function load_complete_ficha() {
            var paciente = parseInt(select_paciente.value);
            if (isNaN(paciente) == true){
                select_odontologo.parentNode.style.display = 'none';
                removeOptions(select_odontologo);
                select_obra_social.parentNode.style.display = 'none';
                removeOptions(select_obra_social);
                select_norma_trabajo.parentNode.style.display = 'none';
                removeOptions(select_norma_trabajo);
            }
            select_paciente.addEventListener("change", cargar_odontologos);
            select_paciente.addEventListener("change", cargar_obras_sociales);
            select_odontologo.addEventListener("change", cargar_obras_sociales);
            select_obra_social.addEventListener("change", cargar_normas_trabajo);
            select_norma_trabajo.addEventListener("change", chequear_norma);
            fecha.addEventListener("change", chequear_norma);

            $('.imagenes-formset').each(function(){
                let filename = $(this).find('.filename').val();
                let url = $(this).find('.url').val();
                let div_preview = $(this).find('.div_preview');
                let img_preview = $(this).find('.img_preview');
                let label_preview = $(this).find('.label_preview');
                $(img_preview).show();
                $(img_preview).attr('src',url);
                
                //IsValidImage(url,filename,img_preview,label_preview,CallbackFunction);
                if(url)
                    $(div_preview).show();
            });

            $('.imagenes-formset').formset({
                addText: '',
                deleteText: '',
                prefix: "{{ imagenes_formset.prefix }}"
            });

            $('.consultas-formset').formset({
                addText: 'Agregar consulta',
                deleteText: '',
                prefix: "{{ consultas_formset.prefix }}"
            });
        }
        window.addEventListener("load", load_complete_ficha, false);

        var xhttp_o = new XMLHttpRequest();
        xhttp_o.onreadystatechange = createCallback(select_odontologo);

        var xhttp_os = new XMLHttpRequest();
        xhttp_os.onreadystatechange = respuestaObraSocial();

        var xhttp_nt = new XMLHttpRequest();
        xhttp_nt.onreadystatechange = createCallback(select_norma_trabajo);

        var xhttp_chequear_norma = new XMLHttpRequest();
        xhttp_chequear_norma.onreadystatechange = createCallbackChequearNorma();

        function respuestaObraSocial(){
            console.log('Cargando obras sociales');
            return function (){
                removeOptions(select_obra_social);
                if (this.readyState == 4 && this.status == 200) {
                    var opt = document.createElement('option');
                    opt.appendChild(document.createTextNode('Seleccionar'));
                    opt.value = '';
                    select_obra_social.appendChild(opt);
                    var arr = JSON.parse(this.responseText);
                    if(arr.length == 0)
                        select_norma_trabajo.parentNode.style.display = 'none';
                    for (i in arr) {
                        opt = document.createElement('option');
                        opt.appendChild(document.createTextNode(arr[i].descrip));
                        opt.value = arr[i].id; 
                        select_obra_social.appendChild(opt);
                    }
                    select_obra_social.parentNode.style.display = 'block';
                }
            }
        }

        function createCallbackChequearNorma() {
            console.log('callback creado para chequear norma');
            return function() {
                if (this.readyState == 4 && this.status == 200) {
                    var today = new Date();  
                    console.log(today + ": " + this.readyState + " - " + this.responseText);
                    var r = JSON.parse(this.responseText);
                    console.log(r);

                    var div_borrar = document.getElementById('mensaje_chequear_norma');
                    if (div_borrar)
                        div_borrar.parentNode.removeChild(div_borrar);
                    
                    div_mensaje = document.createElement('div');
                    div_mensaje.id = 'mensaje_chequear_norma';
                    div_mensaje.classList.add('alert');
                    div_mensaje.style = 'margin-top:5px;'
                    div_mensaje.innerHTML = '<a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>';
                    div_mensaje.innerHTML += '<strong id="resultado_chequear_norma"></strong>';
                    div_mensaje.innerHTML += '<label id="label_mensaje_chequear_norma"></label>';
                    var clase = '';
                    if (r.result == 'OK')
                        clase = 'alert-success';
                    else
                        clase = 'alert-danger';
                    div_mensaje.classList.add(clase);

                    select_norma_trabajo.parentElement.appendChild(div_mensaje);

                    var label_mensaje_chequear_norma = document.getElementById('label_mensaje_chequear_norma');
                    var resultado_chequear_norma = document.getElementById('resultado_chequear_norma');
                    label_mensaje_chequear_norma.innerHTML = r.message;
                    if(r.result != 'OK')
                    {
                        resultado_chequear_norma.innerHTML = r.result;
                        label_mensaje_chequear_norma.innerHTML += ' <a href="'+r.enlace+'" target="blank">VER FICHA</a>'
                    }
                }
            };
        }

        function chequear_norma(){
            var paciente = parseInt(select_paciente.value);
            var norma_trabajo = parseInt(select_norma_trabajo.value);
            console.log('chequear norma: paciente: ' + paciente + ". norma: " + norma_trabajo);
            if (isNaN(paciente) == false && isNaN(norma_trabajo) == false && fecha.value){
                xhttp_chequear_norma.open("GET", "/paciente/chequear_norma?paciente=" + paciente + "&norma_trabajo=" + norma_trabajo + "&fecha=" + fecha.value, true);
                xhttp_chequear_norma.send();
            }
        }
        
        function createCallback(select){
            console.log('callback creado para: ' + select.id);
            return function() {
                console.log(this.responseText);
                removeOptions(select);
                if (this.readyState == 4 && this.status == 200) {
                    var opt = document.createElement('option');
                    opt.appendChild(document.createTextNode('Seleccionar'));
                    opt.value = '';
                    select.appendChild(opt);
                    var arr = JSON.parse(this.responseText);
                    for (i in arr) {
                        opt = document.createElement('option');
                        opt.appendChild(document.createTextNode(arr[i].descrip));
                        opt.value = arr[i].id; 
                        select.appendChild(opt);
                    }
                    select.parentNode.style.display = 'block';
                }
            };
        }

        function cargar_odontologos(){
            console.log('cargar odontologos');
            var paciente = parseInt(select_paciente.value);
            if (isNaN(paciente) == false){
                xhttp_o.open("GET", "/odontologo/get_for_select?paciente=" + paciente, true);
                xhttp_o.send();
            }
            else{
                select_odontologo.parentNode.style.display = 'none';
                removeOptions(select_odontologo);
                select_obra_social.parentNode.style.display = 'none';
                removeOptions(select_obra_social);
                select_norma_trabajo.parentNode.style.display = 'none';
                removeOptions(select_norma_trabajo);
            }
        }

        function cargar_obras_sociales(){
            console.log('cargar obras sociales');
            var paciente = parseInt(select_paciente.value);
            var odontologo = parseInt(select_odontologo.value);
            if (isNaN(odontologo) == false && isNaN(paciente) == false){
                xhttp_os.open("GET", "/obra_social/get_for_select?odontologo=" + odontologo + "&paciente="+ paciente, true);
                xhttp_os.send();
            }
            else{
                select_obra_social.parentNode.style.display = 'none';
                removeOptions(select_obra_social);
                select_norma_trabajo.parentNode.style.display = 'none';
                removeOptions(select_norma_trabajo);
            }
        }

        function cargar_normas_trabajo(){
            var obra_social = parseInt(select_obra_social.value);
            console.log('cargar normas de trabajo de la obra social ' + obra_social);
            if (isNaN(obra_social) == false){
                xhttp_nt.open("GET", "/norma_trabajo/get_for_select?obra_social=" + obra_social, true);
                xhttp_nt.send();
            }
            else{
                select_norma_trabajo.parentNode.style.display = 'none';
                removeOptions(select_norma_trabajo);
            }
        }

        function removeOptions(selectbox){
            var i;
            for(i = selectbox.options.length - 1 ; i >= 0 ; i--)
            {
                selectbox.remove(i);
            }
        }

        function readURL(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    var is_img = input.files[0]['type'].split('/')[0] === 'image';

                    let contenedor = $(input).parent().parent();
                    let div_preview = $(contenedor).find(".div_preview");
                    let img_preview = $(contenedor).find(".img_preview");
                    let label_preview = $(contenedor).find(".label_preview");
                    let img_wrp = $(contenedor).find(".img_wrp");
                    $(img_wrp).show();

                    let filename = $(contenedor).find('.filename');
                    $(filename).val(input.files[0]['name']);

                    console.log(input.files[0]['name']);

                    let label = $(contenedor).find(".label-seleccionar");
                    label.remove();

                    $(div_preview).show();
                    $(img_preview).attr("src", e.target.result);
                    agregar_imagen();
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        $(".cargar_imagen").change(function() {
            readURL(this);
        });

        function eliminar(icon){
            let contenedor = $(icon).parent().parent();
            $(contenedor).remove();
            //$(contenedor).find(".delete-row").click();
        }

        function agregar_imagen(){
            let boton_agegar = document.querySelector(".add-row");
            boton_agegar.click();
        }

        var acc = document.getElementsByClassName("accordion");
        var i;

        for (i = 0; i < acc.length; i++) {
            acc[i].onclick = function(){
                this.classList.toggle("active");
                this.nextElementSibling.classList.toggle("show");
            }
        }

        var IsValidImage = function (url, filename, img_preview, label_preview,callback) {
            $('<img>', {
                src: url,
                error: function () {
                    callback(url, filename, img_preview, label_preview, false);
                },
                load: function () {
                    callback(url, filename, img_preview, label_preview, true);
                }
            });
        }

        var CallbackFunction = function (url, filename, img_preview, label_preview, isValid) {
            if (isValid) {
                $(label_preview).hide();
                $(img_preview).attr("src", url);
                $(img_preview).show();
            } else {
                $(img_preview).hide();
                $(label_preview).html(filename);
                $(label_preview).show();
            }
        }

        function errorImagen(image){
            console.log('error');
            $(image).hide();
            let label = $(image).parent().find('.label_preview');
            let div_preview = $(image).parent().parent(); 
            let contenedor = $(image).parent().parent().parent(); 
            let filename = $(contenedor).find('.filename').val();

            $(label).html(filename);
            $(label).show();
            $(div_preview).show();
        }

        function ver_archivo(label){
            let contenedor = $(label).parent().parent().parent();
            let url = $(contenedor).find('.url').val();
            console.log(url);
            window.open(url,'_blank');
        }

        function ver_imagen(imagen){
            let contenedor = $(imagen).parent().parent().parent();
            let url = $(contenedor).find('.url').val();
            console.log(url);
            window.open($(imagen).attr("src"),'_blank');
        }
    </script>
{% endblock %}
