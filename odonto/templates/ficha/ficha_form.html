{% extends "base.html" %}
{% block head %}
	<title>Crear ficha</title>
{% endblock %}

{% block style %}
{% endblock %}

{% block content %}
    <form method= "POST" id="formulario">
        {% csrf_token %}
        <div class="col-md-6 col-md-offset-3">
            {{form.as_p}}
            <p style="text-align:center;">
                <input type="submit" name="ficha-submit" class="btn" value="Aceptar" />
            </p>
        </div>
    </form>
{% endblock %}

{% block script %}
    <script>
        var select_paciente = document.getElementById('id_paciente');
        var select_odontologo = document.getElementById('id_odontologo');
        var select_obra_social = document.getElementById('id_obra_social');
        var select_norma_trabajo = document.getElementById('id_norma_trabajo');
        var fecha = document.getElementById("id_fecha");

        function load_complete_ficha() {
            var paciente = parseInt(select_paciente.value);
            if (isNaN(paciente) == true){
                select_odontologo.parentNode.style.display = 'none';
                removeOptions(select_odontologo);
                select_obra_social.parentNode.style.display = 'none';
                removeOptions(select_obra_social);
                select_norma_trabajo.parentNode.style.display = 'none';
                removeOptions(select_norma_trabajo);
            }
            select_paciente.addEventListener("change", cargar_odontologos);
            select_paciente.addEventListener("change", cargar_obras_sociales);
            select_odontologo.addEventListener("change", cargar_obras_sociales);
            select_obra_social.addEventListener("change", cargar_normas_trabajo);
            select_norma_trabajo.addEventListener("change", chequear_norma);
            fecha.addEventListener("change", chequear_norma);
        }
        window.addEventListener("load", load_complete_ficha, false);

        var xhttp_o = new XMLHttpRequest();
        xhttp_o.onreadystatechange = createCallback(select_odontologo);
        var xhttp_os = new XMLHttpRequest();
        xhttp_os.onreadystatechange = createCallback(select_obra_social);
        var xhttp_nt = new XMLHttpRequest();
        xhttp_nt.onreadystatechange = createCallback(select_norma_trabajo);
        var xhttp_chequear_norma = new XMLHttpRequest();
        xhttp_chequear_norma.onreadystatechange = createCallbackChequearNorma();

        function createCallbackChequearNorma() {
            console.log('callback creado para chequear norma');
            return function() {
                var today = new Date();  
                console.log(today + ": " + this.readyState + " - " + this.responseText);
                if (this.readyState == 4 && this.status == 200) {
                    
                }
            };
        }

        function chequear_norma(){
            var paciente = parseInt(select_paciente.value);
            var norma_trabajo = parseInt(select_norma_trabajo.value);
            console.log('chequear norma: paciente: ' + paciente + ". norma: " + norma_trabajo);
            if (isNaN(paciente) == false && isNaN(norma_trabajo) == false && fecha.value){
                xhttp_chequear_norma.open("GET", "/paciente/chequear_norma?paciente=" + paciente + "&norma_trabajo=" + norma_trabajo + "&fecha=" + fecha.value, true);
                xhttp_chequear_norma.send();
            }
        }
        
        function createCallback(select) {
            console.log('callback creado para: ' + select.id);
            return function() {
                console.log(this.responseText);
                removeOptions(select);
                if (this.readyState == 4 && this.status == 200) {
                    var opt = document.createElement('option');
                    opt.appendChild(document.createTextNode('Seleccionar'));
                    opt.value = '';
                    select.appendChild(opt);
                    var arr = JSON.parse(this.responseText);
                    for (i in arr) {
                        opt = document.createElement('option');
                        opt.appendChild(document.createTextNode(arr[i].descrip));
                        opt.value = arr[i].id; 
                        select.appendChild(opt);
                    }
                    select.parentNode.style.display = 'block';
                }
            };
        }

        function cargar_odontologos() {
            console.log('cargar odontologos');
            var paciente = parseInt(select_paciente.value);
            if (isNaN(paciente) == false){
                xhttp_o.open("GET", "/odontologo/get_for_select?paciente=" + paciente, true);
                xhttp_o.send();
            }
            else{
                select_odontologo.parentNode.style.display = 'none';
                removeOptions(select_odontologo);
                select_obra_social.parentNode.style.display = 'none';
                removeOptions(select_obra_social);
                select_norma_trabajo.parentNode.style.display = 'none';
                removeOptions(select_norma_trabajo);
            }
        }

        function cargar_obras_sociales() {
            console.log('cargar obras sociales');
            var paciente = parseInt(select_paciente.value);
            var odontologo = parseInt(select_odontologo.value);
            if (isNaN(odontologo) == false && isNaN(paciente) == false){
                xhttp_os.open("GET", "/obra_social/get_for_select?odontologo=" + odontologo + "&paciente="+ paciente, true);
                xhttp_os.send();
            }
            else{
                select_obra_social.parentNode.style.display = 'none';
                removeOptions(select_obra_social);
                select_norma_trabajo.parentNode.style.display = 'none';
                removeOptions(select_norma_trabajo);
            }
        }

        function cargar_normas_trabajo() {
            var obra_social = parseInt(select_obra_social.value);
            console.log('cargar normas de trabajo de la obra social ' + obra_social);
            if (isNaN(obra_social) == false){
                xhttp_nt.open("GET", "/norma_trabajo/get_for_select?obra_social=" + obra_social, true);
                xhttp_nt.send();
            }
            else{
                select_norma_trabajo.parentNode.style.display = 'none';
                removeOptions(select_norma_trabajo);
            }
        }
        function removeOptions(selectbox)
        {
            var i;
            for(i = selectbox.options.length - 1 ; i >= 0 ; i--)
            {
                selectbox.remove(i);
            }
        }
    </script>
{% endblock %}