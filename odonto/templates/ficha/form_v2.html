{% extends "base.html" %}
{% block head %}
	<title>{{ funcion }} {{ficha_form.instance.model_name_lower}}</title>
{% endblock %}

{% block style %}
    <style>
        label.nueva_consulta{
            padding-bottom:5px;
            font-size:15px;
            font-weight:bold;
            color:#413e66;
        }

        .div_preview{
            background-color:#f0eff5;
            padding:10px 5px;
            position:relative;
            border-radius:.25rem;
        }

        .label_preview{
            padding-top:20px;
        }

        .label_preview.descargable:hover{
            color:#1bb1dc;
        }

        .img_preview{
            padding-top:21px;
            width:150px;
        }

        .descargable {
            cursor:pointer;
        }

        .descargable:hover {
            cursor:pointer;
            opacity: 0.5;
            filter: alpha(opacity=50); /* For IE8 and earlier */
        }

        .close {
            position: absolute;
            top: .25rem;
            right: .25rem;
        }

        .add-photo {
            opacity: 0.5;
            filter: alpha(opacity=50); /* For IE8 and earlier */
        }

        .add-photo:hover {
            opacity: 0.3;
            filter: alpha(opacity=100); /* For IE8 and earlier */
        }

        button.accordion {
            background-color:transparent;
            border-radius: .25rem;
            color: #413e66;
            cursor: pointer;
            padding: 10px 18px 5px 18px;
            width: 100%;
            border: 1px solid;
            text-align: left;
            outline: none;
            font-size: 15px;
            transition: 0.2s;
            font-weight:bold;
            border-color:#413e66;
        }

        button.accordion:hover {
            background-color: #f5f8fd;
            color:#1bb1dc;
        }

        button.accordion:hover:after{
            color:#1bb1dc;
        }

        button.accordion.active{
            border-bottom-left-radius:0;
            border-bottom-right-radius:0;
            border-bottom:0;
        }

        button.accordion:after {
            font-family: 'Font Awesome 5 Free';
            font-weight: 900;
            content: "\f103";
            font-size: 20px;
            color: #413e66;
            float: right;
            -webkit-font-smoothing: antialiased;
            text-rendering: auto;
        }

        button.accordion.active:after {
            content: "\f068";
        }

        div.panel {
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            border-bottom: 1px solid;
            border-left: 1px solid;
            border-right: 1px solid;
            border-bottom-left-radius:.25rem;
            border-bottom-right-radius:.25rem;
            border-color:#413e66;
        }

        div.panel.show {
            opacity: 1;
            max-height:fit-content;
            transition: 0.2s;
            overflow: initial;
        }

        .div_nueva_consulta{
            padding-bottom:10px;
        }

        .existente{
            background-color:red;
        }

        .realizar{
            background-color:blue;
        }

        .span-diente{
            display:block;
            width:100%;
            font-weight:bold;
            text-align:center;
            margin-top:-5px;
        }

        .div-diente{
            margin-left:5px;
            moz-user-select: none;
            -khtml-user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .no-selectable{
            moz-user-select: none;
            -khtml-user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        canvas{
            cursor:pointer;
        }

        .separador{
            margin-left:5px;
            width:2px;
            background-color:#566573;
            display:inline-block;
            height:140px;
        }

        .separador-h{
            height:2px;
            background-color:#566573;
            margin-bottom:5px;
            margin-right:-10px;
            margin-left:-5px;
        }

        .span-derecha{
            font-weight: bold;
            position: absolute;
            margin-left: -100px;
            margin-top: 60px;
        }

        .span-izquierda{
            font-weight: bold;
            position: absolute;
            margin-left: 30px;
            margin-top: 60px;
        }
    </style>
{% endblock %}

{% block content %}
{% load staticfiles %}
<div class="col-md">
    {% if messages %}
        {% for message in messages %}
            <p>{{ message }}</p>
        {% endfor %}
    {% endif %}
    <form method= "POST" enctype="multipart/form-data" autocomplete="off">
        {% csrf_token %}
        <ul class="nav nav-tabs" id="myTab" role="tablist" style="margin-bottom:1em;">
            <li class="nav-item">
                <a class="nav-link active" id="nav-datos-tab" data-toggle="tab" href="#nav-datos" role="tab" aria-controls="datos" aria-selected="true">Datos</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="nav-archivos-tab" data-toggle="tab" href="#nav-archivos" role="tab" aria-controls="archivos" aria-selected="false">Archivos</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="nav-historia-tab" data-toggle="tab" href="#nav-historia" role="tab" aria-controls="historia" aria-selected="false">Historia</a>
            </li>
             <li class="nav-item">
                <a class="nav-link" id="nav-odontograma-tab" data-toggle="tab" href="#nav-odontograma" role="tab" aria-controls="odontograma" aria-selected="false">Odontograma</a>
            </li>
        </ul>
        <div class="tab-content" id="nav-tabContent">
            <div class="tab-pane fade show active" id="nav-datos" role="tabpanel" aria-labelledby="nav-datos-tab">
                <div class="row form-group-md">
                    <div class="col-md-4">
                        {{ ficha_form.fecha.errors }}
                        {{ ficha_form.fecha.label_tag }} {{ ficha_form.fecha }}
                        {% if ficha_form.fecha.help_text %}
                            <p class="help">{{ ficha_form.fecha.help_text|safe }}</p>
                        {% endif %}
                    </div>
                    <div class="col-md-4">
                        {{ ficha_form.paciente.errors }}
                        {{ ficha_form.paciente.label_tag }} {{ ficha_form.paciente }}
                        {% if ficha_form.paciente.help_text %}
                            <p class="help">{{ ficha_form.paciente.help_text|safe }}</p>
                        {% endif %}
                    </div>
                    <div class="col-md-4">
                        {{ ficha_form.odontologo.errors }}
                        {{ ficha_form.odontologo.label_tag }} {{ ficha_form.odontologo }}
                        {% if ficha_form.odontologo.help_text %}
                            <p class="help">{{ ficha_form.odontologo.help_text|safe }}</p>
                        {% endif %}
                    </div>
                </div>
                <div class="row form-group-md">
                    <div class="col-md-4">
                        {{ ficha_form.obra_social.errors }}
                        {{ ficha_form.obra_social.label_tag }} {{ ficha_form.obra_social }}
                        {% if ficha_form.obra_social.help_text %}
                            <p class="help">{{ ficha_form.obra_social.help_text|safe }}</p>
                        {% endif %}
                    </div>
                    <div class="col-md-4">
                        {{ ficha_form.plan.errors }}
                        {{ ficha_form.plan.label_tag }} {{ ficha_form.plan }}
                        {% if ficha_form.plan.help_text %}
                            <p class="help">{{ ficha_form.plan.help_text|safe }}</p>
                        {% endif %}
                    </div>
                    <div class="col-md-4">
                        {{ ficha_form.nro_afiliado.errors }}
                        {{ ficha_form.nro_afiliado.label_tag }} {{ ficha_form.nro_afiliado }}
                        {% if ficha_form.nro_afiliado.help_text %}
                            <p class="help">{{ ficha_form.nro_afiliado.help_text|safe }}</p>
                        {% endif %}
                    </div>
                </div>
                <div class="row form-group-md">
                    <div class="col-md-12">
                        {{ ficha_form.observaciones.errors }}
                        {{ ficha_form.observaciones.label_tag }} {{ ficha_form.observaciones }}
                        {% if ficha_form.observaciones.help_text %}
                            <p class="help">{{ ficha_form.observaciones.help_text|safe }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="tab-pane fade" id="nav-archivos" role="tabpanel" aria-labelledby="nav-archivos-tab">
                {{ imagenes_formset.management_form }}
                {% for imagen_form in imagenes_formset %}
                    <div class="imagenes-formset" style="margin-bottom:0.4em;">
                        <div style="display:none;">
                            {{ imagen_form.imagen }}
                            {{ imagen_form.id_img}}
                            {% if imagen_form.initial%}
                                <input class="url" value="{{ imagen_form.initial.imagen.url }}">
                                <input class="filename" value="{{ imagen_form.initial.filename }}">
                            {% else %}
                                <input class="filename" value="">
                            {% endif %}
                        </div>
                        <div style="display:none;" class="div_preview">
                            <a class="close" onclick="eliminar(this);"><i class="fa fa-close"></i></a>
                            <label style="display:none;" class="label_preview" onclick="ver_archivo(this);" title="Descargar archivo">
                                <i class="fa fa-download" style="margin-right:5px;"></i>
                            </label>
                            <img onError="errorImagen(this);" style="display:none;" class="img_preview" onclick="ver_imagen(this);" title="Ver imagen"/>
                            <div id="text-{{imagen_form.descripcion.auto_id}}" style="margin-top:5px;">
                                <span id="span-{{imagen_form.descripcion.auto_id}}"
                                        class="descripcion-imagen"
                                        onclick="editarDescripcionArchivo('{{imagen_form.descripcion.auto_id}}');"
                                        title="Editar detalle">{{imagen_form.initial.descripcion|default_if_none:'-'}}</span>
                                <a href="javascript:editarDescripcionArchivo('{{imagen_form.descripcion.auto_id}}');" class="links">
                                    <i class="fa fa-pencil-square-o" aria-hidden="true" style="margin-left:10px;"></i> Editar descripci√≥n
                                </a>
                            </div>
                            <div id="input-{{imagen_form.descripcion.auto_id}}" style="display:none;">
                                {{imagen_form.descripcion}}
                            </div>
                        </div>
                        {% if not imagen_form.initial %}
                            <label for="{{imagen_form.imagen.auto_id}}" class="label-seleccionar" style="display:block !important;cursor:pointer;">
                                <div style="text-align:center;width:200px;" class="btn-add"><i class="fa fa-plus"></i> Agregar archivo</div>
                            </label>
                        {% endif %}
                        {% if imagen_form.imagen.errors %}
                            {% for error in imagen_form.imagen.errors %}
                                {{ error|escape }}
                            {% endfor %}
                        {% endif %}
                    </div>
                {% endfor %}
                {% if imagen_form.non_form_errors %}
                    {% for error in imagen_form.non_form_errors %}
                        {{ error|escape }}
                    {% endfor %}
                {% endif %}
            </div>
            <div class="tab-pane fade" id="nav-historia" role="tabpanel" aria-labelledby="nav-historia-tab">
                {{ consultas_formset.management_form }}
                {% for form in consultas_formset %}
                    <div class="consultas-formset {% if form.initial %} separador-historias {% endif %}">
                    <div style="display:none;" id="id_consulta">
                        {{ form.id_consulta }}
                    </div>
                    {% if form.initial %}
                        <div class="contenedor-historia">
                            <div class="row">
                                <div class="col-md-4">
                                    <b>Fecha: </b>{{form.initial.fecha}}
                                </div>
                                <div class="col-md-2">
                                {% if form.initial.nro_diente %}
                                    <b>Diente: </b>{{form.initial.nro_diente}}
                                {% endif %}
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <b>Norma de trabajo: </b>{{form.initial.descripcion_norma_trabajo|default_if_none:'-'}}
                                </div>
                            </div>
                            <div class="row" style="">
                                <div class="col-md-12">
                                    <b>Detalle: </b><br/>
                                    <div id="text-{{form.detalle.auto_id}}">
                                        <span id="span-{{form.detalle.auto_id}}"
                                                class="detalle-historia"
                                                onclick="editarDetalleHistoria('{{form.detalle.auto_id}}');"
                                                title="Editar detalle">{{form.initial.detalle|default_if_none:'-'}}</span>
                                        <a href="javascript:editarDetalleHistoria('{{form.detalle.auto_id}}');" class="links">
                                            <i class="fa fa-pencil-square-o" aria-hidden="true" style="margin-left:10px;"></i> Editar detalle
                                        </a>
                                    </div>
                                    <div id="input-{{form.detalle.auto_id}}" style="display:none;">
                                        {{form.detalle}}
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="div_nueva_consulta">
                        <label class="nueva_consulta">Nueva historia:</label>
                        <div class="form-row">
                            <div class="col-md form-group">
                                {{ form.fecha }}
                                {% if form.fecha.errors %}
                                    {% for error in form.fecha.errors %}
                                        {{ error|escape }}
                                    {% endfor %}
                                {% endif %}
                            </div>
                            <div class="col-md form-group">
                                {{ form.nro_diente }}
                                {% if form.nro_diente.errors %}
                                    {% for error in form.nro_diente.errors %}
                                        {{ error|escape }}
                                    {% endfor %}
                                {% endif %}
                            </div>
                            <div class="col-md form-group" >
                                {{ form.norma_trabajo }}
                                {% if form.norma_trabajo.errors %}
                                    {% for error in form.norma_trabajo.errors %}
                                        {{ error|escape }}
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="col-md mensaje">
                            </div>
                        </div>
                        <div class="form-row" style="padding-bottom:10px;">
                            <div class="col-md">
                                {{ form.detalle }}
                                {% if form.detalle.errors %}
                                    {% for error in form.detalle.errors %}
                                        {{ error|escape }}
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                        </div>
                    {% endif%}
                </div>
                {% endfor %}
                {% if consultas_formset.non_form_errors %}
                    {% for error in consultas_formset.non_form_errors %}
                        {{ error|escape }}
                    {% endfor %}
                {% endif %}
            </div>
            <div class="tab-pane fade" id="nav-odontograma" role="tabpanel" aria-labelledby="nav-odontograma-tab">
                <div id="odontograma">
                    <div align="center" style="min-width:700px;" class="no-selectable">
                        <div style="display:inline-block;">
                            <div class="div-diente">
                                <span class="span-diente">18</span>
                                <canvas class="canvas-odontograma"></canvas>
                                {{ficha_form.d18}}
                                {{ficha_form.top18}}
                                {{ficha_form.bot18}}
                                {{ficha_form.left18}}
                                {{ficha_form.right18}}
                            </div>
                            <div class="separador-h"></div>
                            <div class="div-diente">
                                <canvas></canvas>
                                <span class="span-diente">48</span>
                                {{ficha_form.d48}}
                                {{ficha_form.top48}}
                                {{ficha_form.bot48}}
                                {{ficha_form.left48}}
                                {{ficha_form.right48}}
                            </div>
                        </div>
                        <div style="display:inline-block;">
                            <div class="div-diente">
                                <span class="span-diente">17</span>
                                <canvas></canvas>
                                {{ficha_form.d17}}
                                {{ficha_form.top17}}
                                {{ficha_form.bot17}}
                                {{ficha_form.left17}}
                                {{ficha_form.right17}}
                            </div>
                            <div class="separador-h"></div>
                            <div class="div-diente">
                                <canvas></canvas>
                                <span class="span-diente">47</span>
                                {{ficha_form.d47}}
                                {{ficha_form.top47}}
                                {{ficha_form.bot47}}
                                {{ficha_form.left47}}
                                {{ficha_form.right47}}
                            </div>
                        </div>
                        <div style="display:inline-block;">
                            <div class="div-diente">
                                <span class="span-diente">16</span>
                                <canvas></canvas>
                                {{ficha_form.d16}}
                                {{ficha_form.top16}}
                                {{ficha_form.bot16}}
                                {{ficha_form.left16}}
                                {{ficha_form.right16}}
                            </div>
                            <div class="separador-h"></div>
                            <div class="div-diente">
                                <canvas></canvas>
                                <span class="span-diente">46</span>
                                {{ficha_form.d46}}
                                {{ficha_form.top46}}
                                {{ficha_form.bot46}}
                                {{ficha_form.left46}}
                                {{ficha_form.right46}}
                            </div>
                        </div>
                        <div style="display:inline-block;">
                            <div class="div-diente">
                                <span class="span-diente">15</span>
                                <canvas></canvas>
                                {{ficha_form.d15}}
                                {{ficha_form.top15}}
                                {{ficha_form.bot15}}
                                {{ficha_form.left15}}
                                {{ficha_form.right15}}
                            </div>
                            <div class="separador-h"></div>
                            <div class="div-diente">
                                <canvas></canvas>
                                <span class="span-diente">45</span>
                                {{ficha_form.d45}}
                                {{ficha_form.top45}}
                                {{ficha_form.bot45}}
                                {{ficha_form.left45}}
                                {{ficha_form.right45}}
                            </div>
                        </div>
                        <div style="display:inline-block;">
                            <div class="div-diente">
                                <span class="span-diente">14</span>
                                <canvas></canvas>
                                {{ficha_form.d14}}
                                {{ficha_form.top14}}
                                {{ficha_form.bot14}}
                                {{ficha_form.left14}}
                                {{ficha_form.right14}}
                            </div>
                            <div class="separador-h"></div>
                            <div class="div-diente">
                                <canvas></canvas>
                                <span class="span-diente">44</span>
                                {{ficha_form.d44}}
                                {{ficha_form.top44}}
                                {{ficha_form.bot44}}
                                {{ficha_form.left44}}
                                {{ficha_form.right44}}
                            </div>
                        </div>
                        <div style="display:inline-block;">
                            <div class="div-diente">
                                <span class="span-diente">13</span>
                                <canvas></canvas>
                                {{ficha_form.d13}}
                                {{ficha_form.top13}}
                                {{ficha_form.bot13}}
                                {{ficha_form.left13}}
                                {{ficha_form.right13}}
                            </div>
                            <div class="separador-h"></div>
                            <div class="div-diente">
                                <canvas></canvas>
                                <span class="span-diente">43</span>
                                {{ficha_form.d43}}
                                {{ficha_form.top43}}
                                {{ficha_form.bot43}}
                                {{ficha_form.left43}}
                                {{ficha_form.right43}}
                            </div>
                        </div>
                        <div style="display:inline-block;">
                            <div class="div-diente">
                                <span class="span-diente">12</span>
                                <canvas></canvas>
                                {{ficha_form.d12}}
                                {{ficha_form.top12}}
                                {{ficha_form.bot12}}
                                {{ficha_form.left12}}
                                {{ficha_form.right12}}
                            </div>
                            <div class="separador-h"></div>
                            <div class="div-diente">
                                <canvas></canvas>
                                <span class="span-diente">42</span>
                                {{ficha_form.d42}}
                                {{ficha_form.top42}}
                                {{ficha_form.bot42}}
                                {{ficha_form.left42}}
                                {{ficha_form.right42}}
                            </div>
                        </div>
                        <div style="display:inline-block;">
                            <div class="div-diente">
                                <span class="span-diente">11</span>
                                <canvas></canvas>
                                {{ficha_form.d11}}
                                {{ficha_form.top11}}
                                {{ficha_form.bot11}}
                                {{ficha_form.left11}}
                                {{ficha_form.right11}}
                            </div>
                            <div class="separador-h"></div>
                            <div class="div-diente">
                                <canvas></canvas>
                                <span class="span-diente">41</span>
                                {{ficha_form.d41}}
                                {{ficha_form.top41}}
                                {{ficha_form.bot41}}
                                {{ficha_form.left41}}
                                {{ficha_form.right41}}
                            </div>
                        </div>
                        <div class="separador">
                        </div>
                        <div style="display:inline-block;">
                            <div class="div-diente">
                                <span class="span-diente">21</span>
                                <canvas></canvas>
                                {{ficha_form.d21}}
                                {{ficha_form.top21}}
                                {{ficha_form.bot21}}
                                {{ficha_form.left21}}
                                {{ficha_form.right21}}
                            </div>
                            <div class="separador-h"></div>
                            <div class="div-diente">
                                <canvas></canvas>
                                <span class="span-diente">31</span>
                                {{ficha_form.d31}}
                                {{ficha_form.top31}}
                                {{ficha_form.bot31}}
                                {{ficha_form.left31}}
                                {{ficha_form.right31}}
                            </div>
                        </div>
                        <div style="display:inline-block;">
                            <div class="div-diente">
                                <span class="span-diente">22</span>
                                <canvas></canvas>
                                {{ficha_form.d22}}
                                {{ficha_form.top22}}
                                {{ficha_form.bot22}}
                                {{ficha_form.left22}}
                                {{ficha_form.right22}}
                            </div>
                            <div class="separador-h"></div>
                            <div class="div-diente">
                                <canvas></canvas>
                                <span class="span-diente">32</span>
                                {{ficha_form.d32}}
                                {{ficha_form.top32}}
                                {{ficha_form.bot32}}
                                {{ficha_form.left32}}
                                {{ficha_form.right32}}
                            </div>
                        </div>
                        <div style="display:inline-block;">
                            <div class="div-diente">
                                <span class="span-diente">23</span>
                                <canvas></canvas>
                                {{ficha_form.d23}}
                                {{ficha_form.top23}}
                                {{ficha_form.bot23}}
                                {{ficha_form.left23}}
                                {{ficha_form.right23}}
                            </div>
                            <div class="separador-h"></div>
                            <div class="div-diente">
                                <canvas></canvas>
                                <span class="span-diente">33</span>
                                {{ficha_form.d33}}
                                {{ficha_form.top33}}
                                {{ficha_form.bot33}}
                                {{ficha_form.left33}}
                                {{ficha_form.right33}}
                            </div>
                        </div>
                        <div style="display:inline-block;">
                            <div class="div-diente">
                                <span class="span-diente">24</span>
                                <canvas></canvas>
                                {{ficha_form.d24}}
                                {{ficha_form.top24}}
                                {{ficha_form.bot24}}
                                {{ficha_form.left24}}
                                {{ficha_form.right24}}
                            </div>
                            <div class="separador-h"></div>
                            <div class="div-diente">
                                <canvas></canvas>
                                <span class="span-diente">34</span>
                                {{ficha_form.d34}}
                                {{ficha_form.top34}}
                                {{ficha_form.bot34}}
                                {{ficha_form.left34}}
                                {{ficha_form.right34}}
                            </div>
                        </div>
                        <div style="display:inline-block;">
                            <div class="div-diente" id="div_diente_11">
                                <span class="span-diente">25</span>
                                <canvas></canvas>
                                {{ficha_form.d25}}
                                {{ficha_form.top25}}
                                {{ficha_form.bot25}}
                                {{ficha_form.left25}}
                                {{ficha_form.right25}}
                            </div>
                            <div class="separador-h"></div>
                            <div class="div-diente" id="div_diente_41">
                                <canvas></canvas>
                                <span class="span-diente">35</span>
                                {{ficha_form.d35}}
                                {{ficha_form.top35}}
                                {{ficha_form.bot35}}
                                {{ficha_form.left35}}
                                {{ficha_form.right35}}
                            </div>
                        </div>
                        <div style="display:inline-block;">
                            <div class="div-diente" id="div_diente_11">
                                <span class="span-diente">26</span>
                                <canvas></canvas>
                                {{ficha_form.d26}}
                                {{ficha_form.top26}}
                                {{ficha_form.bot26}}
                                {{ficha_form.left26}}
                                {{ficha_form.right26}}
                            </div>
                            <div class="separador-h"></div>
                            <div class="div-diente" id="div_diente_41">
                                <canvas></canvas>
                                <span class="span-diente">36</span>
                                {{ficha_form.d36}}
                                {{ficha_form.top36}}
                                {{ficha_form.bot36}}
                                {{ficha_form.left36}}
                                {{ficha_form.right36}}
                            </div>
                        </div>
                        <div style="display:inline-block;">
                            <div class="div-diente" id="div_diente_11">
                                <span class="span-diente">27</span>
                                <canvas></canvas>
                                {{ficha_form.d27}}
                                {{ficha_form.top27}}
                                {{ficha_form.bot27}}
                                {{ficha_form.left27}}
                                {{ficha_form.right27}}
                            </div>
                            <div class="separador-h"></div>
                            <div class="div-diente" id="div_diente_41">
                                <canvas></canvas>
                                <span class="span-diente">37</span>
                                {{ficha_form.d37}}
                                {{ficha_form.top37}}
                                {{ficha_form.bot37}}
                                {{ficha_form.left37}}
                                {{ficha_form.right37}}
                            </div>
                        </div>
                        <div style="display:inline-block;">
                            <div class="div-diente" id="div_diente_11">
                                <span class="span-diente">28</span>
                                <canvas></canvas>
                                {{ficha_form.d28}}
                                {{ficha_form.top28}}
                                {{ficha_form.bot28}}
                                {{ficha_form.left28}}
                                {{ficha_form.right28}}
                            </div>
                            <div class="separador-h"></div>
                            <div class="div-diente" id="div_diente_41">
                                <canvas></canvas>
                                <span class="span-diente">38</span>
                                {{ficha_form.d38}}
                                {{ficha_form.top38}}
                                {{ficha_form.bot38}}
                                {{ficha_form.left38}}
                                {{ficha_form.right38}}
                            </div>
                        </div>
                        <div style="margin-top:15px;">
                            <span class="span-derecha">DERECHA</span>
                            <div style="display:inline-block;">
                                <div class="div-diente" id="div_diente_15">
                                    <span class="span-diente">55</span>
                                    <canvas></canvas>
                                    {{ficha_form.d55}}
                                    {{ficha_form.top55}}
                                    {{ficha_form.bot55}}
                                    {{ficha_form.left55}}
                                    {{ficha_form.right55}}
                                </div>
                                <div class="separador-h"></div>
                                <div class="div-diente" id="div_diente_45">
                                    <canvas></canvas>
                                    <span class="span-diente">85</span>
                                    {{ficha_form.d85}}
                                    {{ficha_form.top85}}
                                    {{ficha_form.bot85}}
                                    {{ficha_form.left85}}
                                    {{ficha_form.right85}}
                                </div>
                            </div>
                            <div style="display:inline-block;">
                                <div class="div-diente" id="div_diente_14">
                                    <span class="span-diente">54</span>
                                    <canvas></canvas>
                                    {{ficha_form.d54}}
                                    {{ficha_form.top54}}
                                    {{ficha_form.bot54}}
                                    {{ficha_form.left54}}
                                    {{ficha_form.right54}}
                                </div>
                                <div class="separador-h"></div>
                                <div class="div-diente" id="div_diente_44">
                                    <canvas></canvas>
                                    <span class="span-diente">84</span>
                                    {{ficha_form.d84}}
                                    {{ficha_form.top84}}
                                    {{ficha_form.bot84}}
                                    {{ficha_form.left84}}
                                    {{ficha_form.right84}}
                                </div>
                            </div>
                            <div style="display:inline-block;">
                                <div class="div-diente" id="div_diente_13">
                                    <span class="span-diente">53</span>
                                    <canvas></canvas>
                                    {{ficha_form.d53}}
                                    {{ficha_form.top53}}
                                    {{ficha_form.bot53}}
                                    {{ficha_form.left53}}
                                    {{ficha_form.right53}}
                                </div>
                                <div class="separador-h"></div>
                                <div class="div-diente" id="div_diente_43">
                                    <canvas></canvas>
                                    <span class="span-diente">83</span>
                                    {{ficha_form.d83}}
                                    {{ficha_form.top83}}
                                    {{ficha_form.bot83}}
                                    {{ficha_form.left83}}
                                    {{ficha_form.right83}}
                                </div>
                            </div>
                            <div style="display:inline-block;">
                                <div class="div-diente" id="div_diente_12">
                                    <span class="span-diente">52</span>
                                    <canvas></canvas>
                                    {{ficha_form.d52}}
                                    {{ficha_form.top52}}
                                    {{ficha_form.bot52}}
                                    {{ficha_form.left52}}
                                    {{ficha_form.right52}}
                                </div>
                                <div class="separador-h"></div>
                                <div class="div-diente" id="div_diente_42">
                                    <canvas></canvas>
                                    <span class="span-diente">82</span>
                                    {{ficha_form.d82}}
                                    {{ficha_form.top82}}
                                    {{ficha_form.bot82}}
                                    {{ficha_form.left82}}
                                    {{ficha_form.right82}}
                                </div>
                            </div>
                            <div style="display:inline-block;">
                                <div class="div-diente" id="div_diente_11">
                                    <span class="span-diente">51</span>
                                    <canvas></canvas>
                                    {{ficha_form.d51}}
                                    {{ficha_form.top51}}
                                    {{ficha_form.bot51}}
                                    {{ficha_form.left51}}
                                    {{ficha_form.right51}}
                                </div>
                                <div class="separador-h"></div>
                                <div class="div-diente" id="div_diente_41">
                                    <canvas></canvas>
                                    <span class="span-diente">81</span>
                                    {{ficha_form.d81}}
                                    {{ficha_form.top81}}
                                    {{ficha_form.bot81}}
                                    {{ficha_form.left81}}
                                    {{ficha_form.right81}}
                                </div>
                            </div>
                            <div class="separador">
                            </div>
                            <div style="display:inline-block;">
                                <div class="div-diente" id="div_diente_11">
                                    <span class="span-diente">61</span>
                                    <canvas></canvas>
                                    {{ficha_form.d61}}
                                    {{ficha_form.top61}}
                                    {{ficha_form.bot61}}
                                    {{ficha_form.left61}}
                                    {{ficha_form.right61}}
                                </div>
                                <div class="separador-h"></div>
                                <div class="div-diente" id="div_diente_41">
                                    <canvas></canvas>
                                    <span class="span-diente">71</span>
                                    {{ficha_form.d71}}
                                    {{ficha_form.top71}}
                                    {{ficha_form.bot71}}
                                    {{ficha_form.left71}}
                                    {{ficha_form.right71}}
                                </div>
                            </div>
                            <div style="display:inline-block;">
                                <div class="div-diente" id="div_diente_11">
                                    <span class="span-diente">62</span>
                                    <canvas></canvas>
                                    {{ficha_form.d62}}
                                    {{ficha_form.top62}}
                                    {{ficha_form.bot62}}
                                    {{ficha_form.left62}}
                                    {{ficha_form.right62}}
                                </div>
                                <div class="separador-h"></div>
                                <div class="div-diente" id="div_diente_41">
                                    <canvas></canvas>
                                    <span class="span-diente">72</span>
                                    {{ficha_form.d72}}
                                    {{ficha_form.top72}}
                                    {{ficha_form.bot72}}
                                    {{ficha_form.left72}}
                                    {{ficha_form.right72}}
                                </div>
                            </div>
                            <div style="display:inline-block;">
                                <div class="div-diente" id="div_diente_11">
                                    <span class="span-diente">63</span>
                                    <canvas></canvas>
                                    {{ficha_form.d63}}
                                    {{ficha_form.top63}}
                                    {{ficha_form.bot63}}
                                    {{ficha_form.left63}}
                                    {{ficha_form.right63}}
                                </div>
                                <div class="separador-h"></div>
                                <div class="div-diente" id="div_diente_41">
                                    <canvas></canvas>
                                    <span class="span-diente">73</span>
                                    {{ficha_form.d73}}
                                    {{ficha_form.top73}}
                                    {{ficha_form.bot73}}
                                    {{ficha_form.left73}}
                                    {{ficha_form.right73}}
                                </div>
                            </div>
                            <div style="display:inline-block;">
                                <div class="div-diente" id="div_diente_11">
                                    <span class="span-diente">64</span>
                                    <canvas></canvas>
                                    {{ficha_form.d64}}
                                    {{ficha_form.top64}}
                                    {{ficha_form.bot64}}
                                    {{ficha_form.left64}}
                                    {{ficha_form.right64}}
                                </div>
                                <div class="separador-h"></div>
                                <div class="div-diente" id="div_diente_41">
                                    <canvas></canvas>
                                    <span class="span-diente">74</span>
                                    {{ficha_form.d74}}
                                    {{ficha_form.top74}}
                                    {{ficha_form.bot74}}
                                    {{ficha_form.left74}}
                                    {{ficha_form.right74}}
                                </div>
                            </div>
                            <div style="display:inline-block;">
                                <div class="div-diente" id="div_diente_11">
                                    <span class="span-diente">65</span>
                                    <canvas></canvas>
                                    {{ficha_form.d65}}
                                    {{ficha_form.top65}}
                                    {{ficha_form.bot65}}
                                    {{ficha_form.left65}}
                                    {{ficha_form.right65}}
                                </div>
                                <div class="separador-h"></div>
                                <div class="div-diente" id="div_diente_41">
                                    <canvas></canvas>
                                    <span class="span-diente">75</span>
                                    {{ficha_form.d75}}
                                    {{ficha_form.top75}}
                                    {{ficha_form.bot75}}
                                    {{ficha_form.left75}}
                                    {{ficha_form.right75}}
                                </div>
                            </div>
                            <span class="span-izquierda">IZQUIERDA</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <p style="text-align:center;margin-top:10px;">
            <input type="submit" name="ficha-submit" class="btn-lila" value="Aceptar" />
        </p>
    </form>
</div>
{% endblock %}

{% block script %}
    <script src="{% static 'js/jquery.formset.js' %}"></script>
    
    <script>
        var select_obra_social;
        var select_plan;
        var select_paciente;

        const H = 48;
        const W = 36;
        const lado = 10;
        const lineWidth = 1;

        $('document').ready(function(){
            
            select_obra_social = $('#id_obra_social');
            select_plan = $('#id_plan');
            select_paciente = $('#id_paciente');

            $('.imagenes-formset').formset({
                addText: '',
                deleteText: '',
                prefix: "{{ imagenes_formset.prefix }}"
            });

            $('.consultas-formset').formset({
                addText: '<button class="btn-add" type="button"><i class="fa fa-plus"></i> Agregar</button>',
                deleteText: '',
                prefix: "{{ consultas_formset.prefix }}"
            });

            $('.imagenes-formset').each(function(){
                let filename = $(this).find('.filename').val();
                let url = $(this).find('.url').val();
                let div_preview = $(this).find('.div_preview');
                let img_preview = $(this).find('.img_preview');
                let label_preview = $(this).find('.label_preview');
                $(img_preview).show();
                $(img_preview).attr('src',url);
                if(url){
                    $(div_preview).show();
                    $(img_preview).toggleClass('descargable');
                }
            });

            $(select_obra_social).on('change',cargar_planes);

            let acc = $(".accordion");
            for (i = 0; i < acc.length; i++) {
                acc[i].onclick = function(){
                    this.classList.toggle("active");
                    this.nextElementSibling.classList.toggle("show");
                }
            }

            select_paciente.select2({
                tags:true,
                placeholder: 'Haga click para seleccionar',
                allowClear: true,
                language: 'es',
            });

            select_obra_social.select2({
                tags:true,
                placeholder: 'Haga click para seleccionar',
                allowClear: true,
                language: 'es',
            });

            $("#id_odontologo").select2({
                tags:true,
                placeholder: 'Haga click para seleccionar',
                allowClear: true,
                language: 'es',
            });

            select_plan.select2({
                tags:true,
                placeholder: 'Haga click para seleccionar',
                allowClear: true,
                language: 'es',
            });

            $('canvas').each(function(){
                $(this).attr('height', H);
                $(this).attr('width', W);
            });

            draw();
        });

        $('.fecha-consulta').on('change', cambiarFecha);

        var lastJQueryTS = 0 ;

        function cambiarFecha(event) {
            console.log('Fecha seleccionada: ' + this.value);  
            console.log($(this));         
            let send = true;
            if (typeof(event) == 'object'){
                if (event.timeStamp - lastJQueryTS < 300)
                    send = false;
                lastJQueryTS = event.timeStamp;
            }
            if (send){
                let contenedor = $(this).closest('.div_nueva_consulta');
                let select_norma_trabajo = $(contenedor).find('.select-norma-trabajo');
                let norma_trabajo = parseInt($(select_norma_trabajo).val());
                if (isNaN(norma_trabajo) == false)
                    chequear(select_norma_trabajo);
                console.log('Norma trabajo: ' + norma_trabajo);
                if(select_norma_trabajo.children('option').length == 1)
                    cargar_normas_trabajo(select_norma_trabajo);
            }
        }

        function chequear_norma(input){
            let fecha = $(input).val();
            let paciente = $(select_paciente).val();
            let contenedor = $(input).closest('.div_nueva_consulta');
            let select_norma_trabajo = $(contenedor).find('.select-norma-trabajo');
            let norma_trabajo = $(select_norma_trabajo).val();
            if (fecha && paciente && norma_trabajo)
                chequear(select_norma_trabajo);
        }

        function cargar_normas_trabajo(select){
            let obra_social = parseInt($(select_obra_social).val());
            console.log('cargar normas de trabajo de la obra social ' + obra_social);
            $(select).empty();
            $(select).append(new Option('Seleccionar norma', ''))
            if (isNaN(obra_social) == false){
                $.getJSON("/norma_trabajo/get_for_select?obra_social=" + obra_social, function( json ) {
                    let arr = JSON.parse(JSON.stringify(json));
                    for (i in arr) {
                        $(select).append(new Option(arr[i].descrip, arr[i].id))
                    }
                    if(arr.length > 0)
                        $(select).show();
                    else
                        $(select).hide();
                });
            }
            else
                $(select).hide();
        }
        
        $(".cargar_imagen").change(function() {
            readURL(this);
        });

        function readURL(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    var is_img = input.files[0]['type'].split('/')[0] === 'image';

                    let contenedor = $(input).parent().parent();
                    let div_preview = $(contenedor).find(".div_preview");
                    let img_preview = $(contenedor).find(".img_preview");
                    let label_preview = $(contenedor).find(".label_preview");
                    let img_wrp = $(contenedor).find(".img_wrp");
                    $(img_wrp).show();

                    let filename = $(contenedor).find('.filename');
                    $(filename).val(input.files[0]['name']);

                    console.log(input.files[0]['name']);

                    let label = $(contenedor).find(".label-seleccionar");
                    label.remove();

                    $(div_preview).show();
                    $(img_preview).show();
                    $(img_preview).attr("src", e.target.result);
                    agregar_imagen();
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function eliminar(icon){
            $(icon).parent().parent().remove();
        }

        function agregar_imagen(){
            $("#nav-archivos .add-row").click();
        }

        var IsValidImage = function (url, filename, img_preview, label_preview,callback) {
            $('<img>', {
                src: url,
                error: function () {
                    callback(url, filename, img_preview, label_preview, false);
                },
                load: function () {
                    callback(url, filename, img_preview, label_preview, true);
                }
            });
        }

        var CallbackFunction = function (url, filename, img_preview, label_preview, isValid) {
            if (isValid) {
                $(label_preview).hide();
                $(img_preview).attr("src", url);
                $(img_preview).show();
            } else {
                $(img_preview).hide();
                $(label_preview).append(filename);
                $(label_preview).show();
            }
        }

        function errorImagen(image){
            console.log('error');
            $(image).hide();
            let label = $(image).parent().find('.label_preview');
            let div_preview = $(image).parent(); 
            let contenedor = $(div_preview).parent(); 
            let filename = $(contenedor).find('.filename').val();
            let url = $(contenedor).find('.url').val();

            $(label).append(filename);
            if (url)
                $(label).toggleClass('descargable');
            $(label).show();
            $(div_preview).show();
        }

        function ver_archivo(label){
            let contenedor = $(label).parent().parent();
            let url = $(contenedor).find('.url').val();
            window.open(url,'_blank');
        }

        function ver_imagen(imagen){
            let contenedor = $(imagen).parent().parent();
            let url = $(contenedor).find('.url').val();
            console.log(url);
            window.open($(imagen).attr("src"),'_blank');
        }

        function cargar_planes(){
            let obra_social = parseInt($(select_obra_social).val());
            console.log('cargar planes de la obra social ' + obra_social);
            $(select_plan).empty();
            $(select_plan).append(new Option('Seleccionar plan', ''))
            if (isNaN(obra_social) == false){
                $.getJSON("/plan/get_for_select?obra_social=" + obra_social, function( json ) {
                    let arr = JSON.parse(JSON.stringify(json));
                    for (i in arr) {
                        $(select_plan).append(new Option(arr[i].descrip, arr[i].id))
                    }
                    if (arr.length > 0)
                        $(select_plan).parent().show();
                    else
                        $(select_plan).parent().hide();
                });
            }
        }

        function chequear(select){
            let paciente = parseInt(select_paciente.val());
            let norma_trabajo = parseInt($(select).val());
            let contenedor = $(select).closest('.div_nueva_consulta');
            let fecha = $(contenedor).find('.fecha-consulta').val();
            console.log('chequear norma: paciente: ' + paciente + ". norma: " + norma_trabajo);
            let container_mensaje = $(contenedor).find('.mensaje');
            container_mensaje.html('');
            if (isNaN(paciente) == false && isNaN(norma_trabajo) == false && fecha){
                $.getJSON("/paciente/chequear_norma?paciente=" + paciente + "&norma_trabajo=" + norma_trabajo + "&fecha=" + fecha, function( json ) {
                    div_mensaje = document.createElement('div');
                    div_mensaje.id = 'mensaje_chequear_norma';
                    div_mensaje.classList.add('alert');
                    div_mensaje.style = 'margin-top:5px;margin-bottom:0px !important;'
                    div_mensaje.innerHTML = '<a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>';
                    div_mensaje.innerHTML += '<strong id="resultado_chequear_norma"></strong>';
                    div_mensaje.innerHTML += '<label id="label_mensaje_chequear_norma"></label>';

                    container_mensaje.append(div_mensaje);
                    
                    let clase = '';
                    if (json.result == true){
                        clase = 'alert-success';
                        container_mensaje.find('#resultado_chequear_norma').append('Se puede aplicar.');
                    }
                    else{
                        clase = 'alert-danger';
                        container_mensaje.find('#resultado_chequear_norma').append('No se puede aplicar.');
                        container_mensaje.find('#label_mensaje_chequear_norma').append(json.message);
                    }
                    div_mensaje.classList.add(clase);
                });
            }
        }

        function editarDescripcionArchivo(id){
            $(`#text-${id}`).hide();
            $(`#input-${id}`).show();
            let input = $(`#${id}`);
            let val = input.val();
            input.val('');
            input.focus().val(val);
        }

        $('.input-descripcion').focusout(function(){
                let id = $(this).attr('id');
                let val = $(this).val();
                $(`#span-${id}`).html(val);
                $(`#text-${id}`).show();
                $(`#input-${id}`).hide();
        });

        $('.input-descripcion').keypress(function(event){
            if (event.which == 13){
                event.preventDefault();
                let id = $(this).attr('id');
                $(`#text-${id}`).toggle();
                $(`#input-${id}`).toggle();
           }
        });

        function editarDetalleHistoria(id){
            $(`#text-${id}`).hide();
            $(`#input-${id}`).show();
            let input = $(`#${id}`);
            let val = input.val();
            input.val('');
            input.focus().val(val);
        }

        $('.input-detalle').focusout(function(){
                let id = $(this).attr('id');
                let val = $(this).val();
                $(`#span-${id}`).html(val);
                $(`#text-${id}`).show();
                $(`#input-${id}`).hide();
        });

        $('.input-detalle').keypress(function(event){
            if (event.which == 13){
                event.preventDefault();
                let id = $(this).attr('id');
                $(`#text-${id}`).toggle();
                $(`#input-${id}`).toggle();
           }
        });

        $('canvas').click(cambiarEstado);

        $('canvas').contextmenu(limpiarEstado);

        function draw(){
            $('canvas').each(function(){
                let context = $(this)[0].getContext("2d");
                let div = $(this).parent();

                let center = div.find("input[name*='d']").val();
                let top = div.find("input[name*='top']" ).val();
                let bot = div.find("input[name*='bot']" ).val();
                let left = div.find("input[name*='left']" ).val();
                let right = div.find("input[name*='right']" ).val();

                context.clearRect(0,0,context.canvas.width,context.canvas.height);
                context.beginPath();

                context.lineWidth = lineWidth;

                context.strokeStyle = '#1C2833';

                context.rect(lineWidth, lineWidth, W - (lineWidth * 2), H - (lineWidth * 2));
                context.rect(lado, lado, W - (2 * lado), H - (2 * lado));

                context.moveTo(lineWidth, lineWidth);
                context.lineTo(lado, lado);

                context.moveTo(W - lineWidth, lineWidth);
                context.lineTo(W - lado, lado);

                context.moveTo(W - lineWidth, H - lineWidth);
                context.lineTo(W - lado, H - lado);
                
                context.moveTo(lineWidth, H - lineWidth);
                context.lineTo(lado, H - lado);

                context.font = "bold 22px Arial";
                context.textAlign = "center";

                let line_w = 12;
                let x = W / 2;
                let y = (H / 2) + (line_w / 2);
               
                let red = '#E74C3C';
                let blue = '#2874A6';
                let color = 'black';

                switch(center){
                    case 'cruz_roja':
                        context.fillStyle = red;
                        context.fillText("X", x, y, line_w);
                        break;
                    case 's_roja':
                        context.fillStyle = red;
                        context.fillText("S", x, y, line_w);
                        break;
                    case 'cruz_azul':
                        context.fillStyle = blue;
                        context.fillText("X", x, y, line_w);
                        break;
                    case 's_azul':
                        context.fillStyle = blue;
                        context.fillText("S", x, y, line_w);
                        break;
                    case 'ne_azul':
                        context.fillStyle = blue;
                        context.fillText("NE", x, y, line_w);
                        break;
                    case 'ne_roja':
                        context.fillStyle = red;
                        context.fillText("NE", x, y, line_w);
                        break;
                    default:
                        break;
                }

                context.stroke();
                context.beginPath();

                context.strokeStyle = color;

                switch(left){
                    case 'linea':
                        context.moveTo(lado / 2, (H / 2) - lado);
                        context.lineTo(lado / 2, (H / 2) + lado);
                        break;
                    case 'punto':
                        context.moveTo(lado / 2, H / 2);
                        context.arc(lado / 2, H / 2, 2, 0, Math.PI*2, true);
                        break;
                    default:
                        break;
                }

                switch(right){
                    case 'linea':
                        context.moveTo(W - (lado / 2), (H / 2) - lado);
                        context.lineTo(W - (lado / 2), (H / 2) + lado);
                        break;
                    case 'punto':
                        context.moveTo(W - (lado / 2) , H / 2);
                        context.arc(W - (lado / 2) , H / 2, 2, 0, Math.PI*2, true);
                        break;
                    default:
                        break;
                }

                switch(top){
                    case 'linea':
                        context.moveTo((W / 2) - (lado / 2), lado / 2);
                        context.lineTo((W / 2) + (lado / 2), lado / 2);
                        break;
                    case 'punto':
                        context.moveTo(W / 2 , lado / 2);
                        context.arc(W / 2, lado / 2, 2, 0, Math.PI*2, true);
                        break;
                    default:
                        break;
                }

                switch(bot){
                    case 'linea':
                        context.moveTo((W / 2) - (lado / 2), H - (lado / 2));
                        context.lineTo((W / 2) + (lado / 2), H - (lado / 2));
                        break;
                    case 'punto':
                        context.moveTo(W / 2 , H - (lado / 2));
                        context.arc(W / 2, H - (lado / 2), 2, 0, Math.PI*2, true);
                        break;
                    default:
                        break;
                }

                context.stroke();
            });
        }

        function cambiarEstado(event){
            let x = event.offsetX;
            let y = event.offsetY;

            let canvas = $(this);
            let div = canvas.parent();

            let coord = 'X:'+x + ' - Y:'+y;

            if ((x > lado) && (x < W - lado) && (y > lado) && (y < H - lado))
            {
                let input = div.find("input[name*='d']" );
                console.log('value:'+input.val());
                if (input.val() == 'cruz_roja')
                    input.val('s_roja');
                else if(input.val() == 's_roja')
                    input.val('ne_roja');
                else if(input.val() == 'ne_roja')
                    input.val('cruz_azul');
                else if(input.val() == 'cruz_azul')
                    input.val('s_azul');
                else if (input.val() == 's_azul')
                    input.val('ne_azul');
                else if (input.val() == 'ne_azul')
                    input.val('');
                else
                    input.val('cruz_roja');
            }

            if ((x < lado) && (y > lado) && (y < H - lado))
                cambiarValorLado(div.find("input[name*='left']"));

            if ((x > W - lado) && (y > lado) && (y < H - lado))
                cambiarValorLado(div.find("input[name*='right']"));

            if ((y < lado) && (x > lado) && (x < W - lado))
                cambiarValorLado(div.find("input[name*='top']"));
            
            if ((y > H - lado) && (x > lado) && (x < W - lado))
                cambiarValorLado(div.find("input[name*='bot']"));

            draw();
        }

        function cambiarValorLado(i){
            if (i.val() == '')
                i.val('linea');
            else if (i.val() == 'linea')
                i.val('punto');
            else
                i.val('');
        }

        function limpiarEstado(){
            let canvas = $(this);
            let div = canvas.parent();
            let input = div.find('input');
            input.val('');
            draw();
            return false;
        }
    </script>
{% endblock %}